<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Afristar ICT Helpdesk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex items-center justify-center relative overflow-hidden">

    <!-- Video Background -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <iframe
            src="https://www.youtube.com/embed/W0LHTWG-UmQ?autoplay=1&mute=1&controls=0&loop=1&playlist=W0LHTWG-UmQ&showinfo=0&rel=0&playsinline=1"
            class="w-full h-full object-cover scale-150" frameborder="0" allow="autoplay; encrypted-media"
            allowfullscreen>
        </iframe>
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-60"></div>
    </div>

    <div
        class="bg-white bg-opacity-95 p-8 rounded-lg shadow-lg w-full max-w-md z-10 hover:bg-opacity-100 transition duration-300">
        <div class="flex justify-center mb-6">
            <img src="/images/logo.jpg" alt="Afristar Logo" class="h-32 object-contain">
        </div>
        <h1 class="text-xl font-bold mb-6 text-center text-gray-800">Helpdesk Login</h1>

        <form id="loginForm" class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="staffId">Staff ID</label>
                <input type="text" id="staffId"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="e.g. M10256" required>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Password</label>
                <input type="password" id="password"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required>
            </div>

            <div id="errorMessage" class="text-red-500 text-sm hidden"></div>

            <button type="submit"
                class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                Sign In
            </button>
        </form>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const staffId = document.getElementById('staffId').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');

            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ staffId, password })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    if (result.message === 'Password reset required') {
                        // Show Reset Modal
                        const userId = result.data.userId;
                        showResetModal(userId);
                    } else {
                        // Normal Login
                        localStorage.setItem('token', result.data.token);
                        window.location.href = '/dashboard.html';
                    }
                } else {
                    errorMessage.textContent = result.message || 'Login failed';
                    errorMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = 'An error occurred. Please try again.';
                errorMessage.classList.remove('hidden');
            }
        });

        function showResetModal(userId) {
            // Simple injected modal
            const modalHtml = `
            <div id="resetModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">Reset Password</h2>
                    <p class="text-gray-600 mb-4 text-sm">You are logging in with a temporary password. Please set a new password.</p>
                    <form id="resetForm" class="space-y-4">
                        <input type="hidden" id="resetUserId" value="${userId}">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">New Password</label>
                            <input type="password" id="newPassword" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Update Password</button>
                    </form>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('resetForm').addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const uid = document.getElementById('resetUserId').value;

                try {
                    const res = await fetch('/api/v1/auth/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: uid, newPassword })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        alert('Password updated! Please login again with your new password.');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (err) {
                    alert('Error resetting password');
                }
            });
        }
    </script>
</body>

</html>